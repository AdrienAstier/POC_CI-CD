name: Build et Deploy

# DÃ©clencheurs
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Jobs
jobs:
  # Job 1: Tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: ExÃ©cution des tests
      run: |
        echo "ğŸ§ª Lancement des tests..."
        
        # VÃ©rifier que les fichiers existent
        if [ ! -f "index.html" ]; then
          echo "âŒ Fichier index.html manquant"
          exit 1
        fi
        
        if [ ! -f "script.js" ]; then
          echo "âŒ Fichier script.js manquant"
          exit 1
        fi
        
        if [ ! -f "style.css" ]; then
          echo "âŒ Fichier style.css manquant"
          exit 1
        fi
        
        echo "âœ… Tous les fichiers sont prÃ©sents"
        
        # VÃ©rifier la syntaxe HTML
        echo "ğŸ” VÃ©rification HTML..."
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… DOCTYPE HTML trouvÃ©"
        else
          echo "âŒ DOCTYPE HTML manquant"
          exit 1
        fi
        
        # VÃ©rifier la syntaxe JavaScript
        echo "ğŸ” VÃ©rification JavaScript..."
        if grep -q "function calculate" script.js; then
          echo "âœ… Fonction calculate trouvÃ©e"
        else
          echo "âŒ Fonction calculate manquante"
          exit 1
        fi
        
        echo "ğŸ‰ Tous les tests sont passÃ©s!"

  # Job 2: Build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Mise Ã  jour de la date de build
      run: |
        echo "ğŸ“… Mise Ã  jour de la date de build..."
        sed -i "s/new Date().toLocaleDateString('fr-FR')/\"$(date +'%d\/%m\/%Y Ã  %H:%M')\"/g" script.js
        echo "Version: $(date +'%Y%m%d-%H%M%S')" > version.txt
    
    - name: CrÃ©ation de l'artefact
      uses: actions/upload-artifact@v4
      with:
        name: site-web
        path: |
          index.html
          style.css
          script.js
          version.txt
          README.md

  # Job 3: Deploy sur GitHub Pages
  deploy:
    name: DÃ©ploiement
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Permissions pour GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    # Environment de dÃ©ploiement
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: TÃ©lÃ©chargement de l'artefact
      uses: actions/download-artifact@v4
      with:
        name: site-web
        path: ./dist
    
    - name: Configuration GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: Upload vers GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
    
    - name: DÃ©ploiement sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Notification de succÃ¨s
      run: |
        echo "ğŸš€ DÃ©ploiement terminÃ©!"
        echo "ğŸŒ Site disponible Ã : ${{ steps.deployment.outputs.page_url }}"

  # Job 4: Notification
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
    - name: Statut de la pipeline
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… Pipeline rÃ©ussie!"
          echo "ğŸ‰ Application prÃªte en production"
        else
          echo "âŒ Pipeline Ã©chouÃ©e!"
          echo "ğŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
        fi